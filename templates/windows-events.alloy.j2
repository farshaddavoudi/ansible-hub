//
// Windows Event Log receivers
//
{% for channel in windows_event_channels %}
otelcol.receiver.windows_event_log "{{ channel.name.lower() }}_logs" {
  channel = "{{ channel.name }}"
  
  // Optional: filter specific event IDs or sources
  // xpath_query = "*[System[Level=1 or Level=2 or Level=3]]"  // Error, Critical, Warning only
}

otelcol.processor.attributes "{{ channel.name.lower() }}_log_attributes" {
  actions = [
    {
      key    = "source"
      action = "insert"
      value  = "server"
    },
    {
      key    = "server"
      action = "insert"
      value  = "{{ server_identifier }}"
    },
    {
      key    = "service_name"
      action = "insert"
      value  = "{{ server_identifier }}"
    },
    {
      key    = "category"
      action = "insert"
      value  = "windows_event"
    },
    {
      key    = "subcategory"
      action = "insert"
      value  = "{{ channel.subcategory }}"
    },
    {
      key    = "log_type"
      action = "insert"
      value  = "event_log"
    }
  ]
}

{% endfor %}

//
// Loki writer for Windows Event Logs
//
loki.write "windows_events" {
  endpoint {
    url = "{{ loki_endpoint_url }}"
  }
}

//
// Pipeline configuration
//
otelcol.service "windows_event_logs" {
  pipelines {
    logs = [
{% for channel in windows_event_channels %}
      otelcol.receiver.windows_event_log.{{ channel.name.lower() }}_logs.output,
      otelcol.processor.attributes.{{ channel.name.lower() }}_log_attributes.output,
{% endfor %}
      loki.write.windows_events.input,
    ]
  }
}